<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Completing Sign In...</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .container {
      text-align: center;
      padding: 40px;
      max-width: 500px;
    }

    .logo {
      font-size: 48px;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 10px 0;
    }

    p {
      font-size: 16px;
      opacity: 0.9;
      margin: 0 0 30px 0;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status {
      font-size: 14px;
      opacity: 0.8;
      margin-top: 20px;
    }

    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.5);
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">⚖️</div>
    <h1>Completing Sign In...</h1>
    <p>Please wait while we complete your authentication.</p>
    <div class="spinner"></div>
    <p class="status" id="status">Processing...</p>
    <div id="error" class="error" style="display: none;"></div>
  </div>

  <script type="module">
    (async function() {
      const statusEl = document.getElementById('status');
      const errorEl = document.getElementById('error');

      try {
        // Get the current URL with OAuth code
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        if (error) {
          throw new Error(`OAuth error: ${error}`);
        }

        if (!code) {
          throw new Error('No authorization code received');
        }

        console.log('✅ OAuth code received:', code.substring(0, 10) + '...');

        // Check if this is a mobile device
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        if (isMobile) {
          // Mobile: Try Universal Links / App Links first
          statusEl.textContent = 'Opening Norma AI app...';

          // Construct the deep link URL with the code
          const deepLinkUrl = `normaai://auth/callback?code=${encodeURIComponent(code)}`;

          // Try to open the app via deep link
          window.location.href = deepLinkUrl;

          // If app doesn't open in 2 seconds, the user might not have the app installed
          // In that case, process the OAuth in the web browser
          setTimeout(() => {
            statusEl.textContent = 'App not detected. Completing sign in in browser...';
            // Let the web app handle it via index.html
            window.location.href = `/?code=${encodeURIComponent(code)}`;
          }, 2000);

        } else {
          // Desktop: Try to open the app via custom URL scheme
          statusEl.textContent = 'Opening Norma AI desktop app...';

          const deepLinkUrl = `normaai://auth/callback?code=${encodeURIComponent(code)}`;

          // Create invisible iframe to trigger deep link
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = deepLinkUrl;
          document.body.appendChild(iframe);

          // Also try direct navigation
          setTimeout(() => {
            window.location.href = deepLinkUrl;
          }, 100);

          // If deep link doesn't work after 3 seconds, show web fallback
          setTimeout(() => {
            statusEl.textContent = 'Desktop app not detected. Completing sign in in browser...';
            // Redirect to main app which will handle the code
            window.location.href = `/?code=${encodeURIComponent(code)}`;
          }, 3000);
        }

      } catch (err) {
        console.error('❌ OAuth callback error:', err);
        statusEl.textContent = 'Error';
        errorEl.textContent = err.message || 'An error occurred during sign in';
        errorEl.style.display = 'block';

        // Redirect to home after showing error
        setTimeout(() => {
          window.location.href = '/';
        }, 5000);
      }
    })();
  </script>
</body>
</html>
