name: Desktop App Release

on:
  push:
    branches: [main, master] # Triggers on every push to master
  workflow_dispatch: # Allow manual triggering from GitHub UI

jobs:
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version from package.json
        run: echo "PACKAGE_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: Create release
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = `v${process.env.PACKAGE_VERSION}`;

            // Check if release already exists
            try {
              const { data: existingRelease } = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tagName
              });
              console.log(`Release ${tagName} already exists, using existing release ID`);
              return existingRelease.id;
            } catch (error) {
              if (error.status === 404) {
                // Release doesn't exist, create it
                const { data } = await github.rest.repos.createRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag_name: tagName,
                  name: `Norma AI Desktop v${process.env.PACKAGE_VERSION}`,
                  body: 'See the CHANGELOG for details.',
                  draft: true,
                  prerelease: false
                });
                return data.id;
              }
              throw error;
            }

  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target universal-apple-darwin'
          - platform: 'ubuntu-latest'
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install Node dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ matrix.args }}

      - name: Upload Windows installer to FTP
        if: matrix.platform == 'windows-latest'
        run: |
          # Find the generated setup.exe file
          $exeFile = Get-ChildItem -Path "src-tauri\target\release\bundle\nsis" -Filter "*-setup.exe" -Recurse | Select-Object -First 1

          if ($exeFile) {
            Write-Host "Found installer: $($exeFile.FullName)"

            # Copy and rename to consistent name
            $targetFile = "Norma-AI-Setup.exe"
            Copy-Item $exeFile.FullName -Destination $targetFile

            Write-Host "Renamed to: $targetFile"
            Write-Host "Uploading to FTP server..."

            # Upload via FTP using curl with passive mode and directory creation
            $exitCode = 0
            curl.exe -T $targetFile `
              --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" `
              --ftp-pasv `
              --ftp-create-dirs `
              -v `
              "ftp://normaai.rs/downloads/$targetFile"
            $exitCode = $LASTEXITCODE

            if ($exitCode -eq 0) {
              Write-Host "✓ Upload completed successfully!"
            } else {
              Write-Host "✗ Upload failed with exit code: $exitCode"
              Write-Host "Trying alternative path (root directory)..."

              # Try uploading to root if /downloads/ failed
              curl.exe -T $targetFile `
                --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" `
                --ftp-pasv `
                -v `
                "ftp://normaai.rs/$targetFile"

              if ($LASTEXITCODE -eq 0) {
                Write-Host "✓ Upload to root completed successfully!"
              } else {
                Write-Host "✗ Upload failed. Please check FTP permissions and path."
                exit 1
              }
            }
          } else {
            Write-Host "No installer found to upload"
          }
        shell: pwsh

  publish-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    needs: [create-release, build-tauri]

    steps:
      - name: Publish release
        id: publish-release
        uses: actions/github-script@v7
        env:
          release_id: ${{ needs.create-release.outputs.release_id }}
        with:
          script: |
            github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: process.env.release_id,
              draft: false,
              prerelease: false
            })
